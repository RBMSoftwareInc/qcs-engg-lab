<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		%sveltekit.head%
		<script>
			// CRITICAL: Patch JSON parsing BEFORE any code loads
			// This prevents ALL JSON.parse errors from Studio API calls
			(function() {
				'use strict';
				
				// Patch Response.json() IMMEDIATELY
				if (typeof Response !== 'undefined' && Response.prototype) {
					const originalJson = Response.prototype.json;
					Response.prototype.json = async function() {
						try {
							const contentType = this.headers.get('content-type') || '';
							const text = await this.text();
							if (contentType.includes('text/html') || text.trim().startsWith('<!')) {
								return {};
							}
							try {
								return JSON.parse(text);
							} catch {
								return {};
							}
						} catch {
							return {};
						}
					};
				}
				
				// Patch JSON.parse() IMMEDIATELY
				const originalParse = JSON.parse;
				JSON.parse = function(text, reviver) {
					try {
						if (typeof text === 'string' && text.trim().startsWith('<!')) {
							return {};
						}
						return originalParse.call(this, text, reviver);
					} catch (error) {
						if (window.location.pathname && window.location.pathname.startsWith('/studio')) {
							return {};
						}
						throw error;
					}
				};
				
				// Global error handler
				window.addEventListener('unhandledrejection', function(event) {
					if (event.reason instanceof SyntaxError && 
						event.reason.message && 
						event.reason.message.includes('Unexpected token') &&
						window.location.pathname && 
						window.location.pathname.startsWith('/studio')) {
						event.preventDefault();
						event.stopPropagation();
						return false;
					}
				}, true);
			})();
		</script>
	</head>
	<body data-sveltekit-preload-data="hover">
		<div style="display: contents">%sveltekit.body%</div>
	</body>
</html>
